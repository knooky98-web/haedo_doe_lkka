import 'dart:math';

/// ===============================
/// 이유 더 보기 문구 엔진
/// - [팩트] + [해석] + [대안] 3단 조합
/// - result(STRONG_OK/OK/MAYBE/NO/STRONG_NO) + 패턴 + 행동타입으로 조건부 선택
/// - 행동 타입별 "맞춤형 대안" 풀(30개씩) 포함
/// ===============================

enum ReasonTone { strongOk, ok, maybe, no, strongNo }

enum ActionType {
  general,
  money,     // 구매/지출/돈
  alcohol,   // 술
  phone,     // 자기전 폰/폰
  game,      // 게임
  caffeine,  // 카페인
  food,      // 폭식/야식
  workout,   // 운동
  selfcare,  // 자기관리
  rest,      // 휴식
  sleep,     // 수면 관련(필요 시)
}

ActionType actionTypeFromActionName(String action) {
  switch (action) {
    case '구매':
    case '지출':
    case '돈':
      return ActionType.money;

    case '술':
      return ActionType.alcohol;

    case '자기전 폰':
    case '폰':
      return ActionType.phone;

    case '게임':
      return ActionType.game;

    case '카페인':
      return ActionType.caffeine;

    case '폭식':
    case '야식':
      return ActionType.food;

    case '운동':
      return ActionType.workout;

    case '자기관리':
      return ActionType.selfcare;

    case '휴식':
      return ActionType.rest;

    default:
      return ActionType.general;
  }
}

class PatternLite {
  final int cnt3; // 최근 3일 횟수
  final int cnt5; // 최근 5일 횟수
  final int hoursSinceLast;
  final int streak;

  const PatternLite({
    required this.cnt3,
    required this.cnt5,
    required this.hoursSinceLast,
    required this.streak,
  });
}

class ReasonPack {
  final String fact;
  final String interpret;
  final String alternative;

  const ReasonPack({
    required this.fact,
    required this.interpret,
    required this.alternative,
  });

  String toMultiline() => '$fact\n$interpret\n\n$alternative';
}

T _pickOne<T>(List<T> list, Random r) => list[r.nextInt(list.length)];

ReasonTone _toneFromResult(String result) {
  switch (result) {
    case 'STRONG_OK':
      return ReasonTone.strongOk;
    case 'OK':
      return ReasonTone.ok;
    case 'MAYBE':
      return ReasonTone.maybe;
    case 'NO':
      return ReasonTone.no;
    case 'STRONG_NO':
      return ReasonTone.strongNo;
    default:
      return ReasonTone.maybe;
  }
}

// ---------- FACTS ----------
final List<String Function(PatternLite p)> _factsStable = [
      (p) => '최근 기록 흐름은 전반적으로 안정적인 편이에요.',
      (p) => '간격과 빈도가 무리 없는 범위에 있어요.',
      (p) => '최근 패턴은 컨트롤이 잘 되는 쪽이에요.',
      (p) => '최근 5일 기준 과한 쏠림은 없어 보여요.',
      (p) => '최근 3일 기준 크게 몰리는 느낌은 아니에요.',
];

final List<String Function(PatternLite p)> _factsFreq = [
      (p) => '최근 3일 기준 이 행동이 ${p.cnt3}회 있었어요.',
      (p) => '최근 5일 기준 이 행동이 ${p.cnt5}회 있었어요.',
      (p) => '이번 주에 이 유형의 선택이 자주 등장했어요.',
      (p) => '최근엔 빈도가 이전보다 늘어난 편이에요.',
      (p) => '요 며칠 같은 선택이 반복되는 경향이 보여요.',
];

final List<String Function(PatternLite p)> _factsGap = [
      (p) => '마지막 기록 이후 ${p.hoursSinceLast}시간밖에 지나지 않았어요.',
      (p) => '간격이 짧게 이어지고 있는 편이에요.',
      (p) => '회복 시간 없이 연속으로 이어지는 흐름이 보여요.',
      (p) => '충분히 쉬기 전에 다시 선택할 가능성이 있어요.',
      (p) => '지금은 텀을 더 주면 흐름이 좋아질 수 있어요.',
];

final List<String Function(PatternLite p)> _factsStreak = [
      (p) => '이 선택이 연속으로 ${p.streak}번 이어졌어요.',
      (p) => '최근 패턴이 “연속성” 쪽으로 기울어 있어요(연속 ${p.streak}).',
      (p) => '연속이 쌓이면 선택이 자동화되기 쉬워요.',
      (p) => '지금 흐름은 “한 번 더”가 붙기 쉬운 구간이에요.',
      (p) => '연속을 끊어주면 컨트롤이 확 좋아져요.',
];

// ---------- INTERPRETS ----------
final List<String> _interpretStable = [
  '전체 흐름은 안정적이고, 크게 부담되는 패턴은 아니에요.',
  '회복과 균형이 함께 보이는 상태예요.',
  '지금 선택은 무리 없이 괜찮은 편이에요.',
  '지금은 “금지”보다 “유지”가 더 맞는 구간이에요.',
  '컨트롤이 가능한 상태라 과하지만 않으면 괜찮아요.',
];

final List<String> _interpretHabitRisk = [
  '이 정도 빈도면 습관으로 굳어질 가능성이 있어요.',
  '의도적 선택이라기보다 자동 반응에 가까워질 수 있어요.',
  '반복 자체보다 “속도”가 빠른 편이라 신호로 볼 수 있어요.',
  '한 번은 괜찮지만 누적되면 내일 컨디션을 깎을 수 있어요.',
  '지금은 “선” 없이 가면 쉽게 과해질 수 있어요.',
];

final List<String> _interpretRecoveryNeed = [
  '간격이 짧아서 회복이 충분하지 않았을 수 있어요.',
  '지금 흐름이면 피로가 누적될 가능성이 있어요.',
  '지금은 밀어붙이기보다 균형 회복이 우선인 구간이에요.',
  '회복이 덜 된 상태에서 반복되면 손해가 커질 수 있어요.',
  '오늘은 “회복비용”이 더 비싸게 나올 수 있어요.',
];

final List<String> _interpretContextSignal = [
  '당장의 문제라기보다 방향 점검용 신호에 가까워요.',
  '한 번은 괜찮지만 연속성은 체크 포인트가 될 수 있어요.',
  '지금은 “금지”보다 “조절”이 더 맞는 시점이에요.',
  '선택의 목적만 분명하면 결과가 훨씬 좋아져요.',
  '규칙 1개만 붙이면 충분히 괜찮아질 수 있어요.',
];

// ---------- ALTERNATIVES (30개씩: 행동타입별 “맞춤형 대안”) ----------
final Map<ActionType, List<String>> _altsByType = {
  ActionType.general: [
    '오늘은 강도를 낮춘 버전으로 바꿔도 좋아요.',
    '횟수는 유지하되 시간을 줄이는 방식도 괜찮아요.',
    '완전히 안 하기보다 “가볍게”로 조절하는 게 현실적이에요.',
    '조건을 하나 붙여서(시간/횟수/장소) 통제해보는 건 어때요?',
    '연속만 끊는 룰(예: 하루 건너뛰기)로도 충분히 달라져요.',
    '지금 말고 내일로 한 번 미뤄도 흐름은 좋아져요.',
    '10분만 먼저 하고 계속할지 다시 결정해봐요.',
    '끝나는 시간을 먼저 박아두고 시작해요.',
    '시작 전 “목표 1개”만 정하고 들어가요.',
    '오늘은 “짧게 하고 마감”이 정답일 수 있어요.',
    '환경을 바꿔서 루트를 바꾸는 쪽이 더 쉬울 수 있어요.',
    '만족은 유지하고 비용은 줄이는 대안 1개를 골라봐요.',
    '지금은 괜찮지만 연속될 것 같으면 한 번 더 점검해요.',
    '오늘 선택은 가능하지만 다음엔 간격을 의식해보세요.',
    '“이번까지만” 대신 “규칙 1개”로 관리해봐요.',
    '손해가 커지기 전에 멈출 기준을 미리 정해요.',
    '지금은 회복을 1순위로 두는 것도 선택이에요.',
    '하고 싶으면 하되, 강도는 절반으로 시작해요.',
    '오늘은 “대안 먼저” 하고 그래도 필요하면 하자.',
    '실행보다 기록만 하고 30분 뒤 재평가해요.',
    '오늘은 “작게 성공”으로 끝내는 게 이득이에요.',
    '동기(왜 하는지)를 한 줄로 써보고 시작해요.',
    '내일의 나가 고마워할 버전으로 바꿔봐요.',
    '시간/강도/돈 중 하나는 반드시 제한 걸고 가요.',
    '연속만 끊어도 충분히 좋아져요.',
    '리스크가 크면 “미루기”가 가장 강한 대안이에요.',
    '지금은 “회복 + 정리” 조합이 더 효율적일 수 있어요.',
    '컨디션이 떨어졌으면 “짧게”가 답이에요.',
    '한 번 더 하려면, 먼저 물/정리/샤워 같은 완충을 넣어요.',
    '오늘은 “선택의 질”을 높이는 쪽으로 가요.',
  ],

  ActionType.money: [
    '오늘은 “예산 상한”을 먼저 정하고 그 안에서만 써요.',
    '지금 결제 말고 장바구니에 넣고 24시간 보류해요.',
    '필요한 것 “1개만” 사고 종료하는 룰로 가요.',
    '비슷한 만족을 주는 “무료/저가” 대안을 먼저 찾아봐요.',
    '오늘은 현금/체크카드처럼 “즉시 체감” 결제로 바꿔요.',
    '배송/수령 시간을 늦춰서 충동을 식히는 것도 방법이에요.',
    '리스트에 없던 지출이면 “내일 다시 보기”로 넘겨요.',
    '구매 전 “왜 필요한지 1문장” 적고 진행해요.',
    '중복 소지가 있으면 “집에 있는 대체품”부터 확인해요.',
    '오늘은 “필수/선택” 분리 후 필수만 집행해요.',
    '지출 대신 “정리/환불/중고판매” 같은 회수 행동을 해봐요.',
    '구매 대신 “수리/정비”로 해결 가능한지 먼저 봐요.',
    '가격 비교는 10분까지만, 그 이상이면 보류해요.',
    '오늘은 “세일”이 아니라 “필요” 기준으로만 결정해요.',
    '한도 룰: 오늘은 ‘OO원’ 이상은 무조건 보류해요.',
    '카드 등록 삭제/원클릭 결제 해제 같은 장벽을 하나 추가해요.',
    '지금 사려는 물건을 “대여/빌리기”로 바꿀 수 있어요.',
    '같은 돈이면 “경험/회복” 쪽이 더 이득일 수 있어요.',
    '지출 전 5분 산책/물 한 잔으로 충동을 낮추고 다시 봐요.',
    '결제 전 “내일의 나”에게 허락 받는 느낌으로 다시 체크해요.',
    '대안: 1) 보류 2) 장바구니 3) 최소 1개만',
    '오늘은 “비슷한 만족 + 더 낮은 비용”만 허용해요.',
    '필요하면 사되, “반품 가능/환불 쉬운” 옵션으로 가요.',
    '지금은 지출보다 “정리/기록”이 더 큰 이득일 수 있어요.',
    '욕구가 크면 “예산 안에서 작은 버전”으로 타협해요.',
    '오늘은 구매 대신 위시리스트/메모만 남기고 종료해요.',
    '구매 후회를 줄이려면 “사용 장면 3개”가 떠오를 때만 사요.',
    '충동이면 “내일 오전”에 다시 판단하기로 룰을 걸어요.',
    '이미 비슷한 걸 최근에 샀다면 “이번은 패스”가 이득이에요.',
    '오늘은 “소비 0” 챌린지로 하루만 끊어봐요.',
  ],

  ActionType.alcohol: [
    '오늘은 1~2잔까지만(상한선)으로 시작해요.',
    '2차 없이 귀가를 “룰”로 박아두고 가요.',
    '물 1잔/안주/수면을 세트로 챙기는 버전으로 바꿔요.',
    '늦게 시작했다면 “한 잔만” 하고 마감해요.',
    '술 대신 무알콜/탄산/차로 분위기만 가져가요.',
    '오늘은 “천천히(속도 제한)”가 핵심이에요.',
    '대화 목적이면 술보다 “장소/사람”에 집중해요.',
    '오늘은 집에서 쉬고 내일 맑은 컨디션으로 만나요.',
    '술자리 전 간단히 먹고 시작해서 급상승을 막아요.',
    '귀가 시간(예: 12시)을 먼저 정하고 지켜요.',
    '“샷/고도수 금지” 룰을 추가해요.',
    '오늘은 술 대신 산책/카페/간식으로 만족을 바꿔요.',
    '술 마신 다음날 일정이 있으면 오늘은 쉬는 게 이득이에요.',
    '연속이면 하루 건너뛰기로 흐름을 끊어줘요.',
    '오늘은 0잔도 충분히 좋은 선택이에요.',
    '술 대신 ‘분위기 행동’(음악/대화/보드게임)으로 대체해요.',
    '진짜 이유가 스트레스면 “회복 행동”이 더 효율적이에요.',
    '오늘은 “수면 보호”를 우선으로 둬요.',
    '한 잔만 마시고 “샤워+물”로 마무리해요.',
    '술자리라면 “음료 1잔당 물 1잔” 룰로 가요.',
    '오늘은 “귀가 후 야식 금지”까지 세트로 걸어요.',
    '불가피하면 “낮은 도수 + 적은 양”으로만.',
    '컨디션이 안 좋으면 오늘은 멈추는 게 승리예요.',
    '다음날 후회가 떠오르면 지금은 스탑이 맞아요.',
    '술 대신 ‘잠깐의 휴식’으로 감정을 내려놔요.',
    '오늘은 “대안 1개”를 먼저 하고, 그래도 원하면 마셔요.',
    '연속이 쌓이면 루틴이 무너지기 쉬워요. 하루 쉬자.',
    '내일의 나를 살리려면 “오늘은 쉬기”가 최선일 수 있어요.',
    '마실 거면 “선(잔수/시간)”을 종이에 써놓고 시작해요.',
    '마무리 룰: 귀가 즉시 물/양치/취침으로 끝내요.',
  ],

  ActionType.phone: [
    '10분 타이머 걸고 끝내는 버전으로 바꿔요.',
    '침대 밖에서만 보기(침대=수면) 룰을 걸어요.',
    '자극 콘텐츠(쇼츠/추천) 금지하고 필요한 것만 봐요.',
    '알림을 끄고, 앱 1개만 허용해요.',
    '흑백 모드/야간 모드로 흥분도를 낮춰요.',
    '오늘은 폰 대신 책/음악/스트레칭으로 전환해요.',
    '핵심 목적(연락/정보/휴식)만 하고 바로 종료해요.',
    '“충전은 거실”로 위치를 바꿔요.',
    '잠들기 30분 전부터 폰 금지로 룰을 걸어요.',
    '침대 들어가기 전에 해야 할 것 1개만 하고 들어가요.',
    '쇼츠 대신 긴 영상 1개만(선택 비용↑)으로 바꿔요.',
    '자기 전엔 “스피커/팟캐스트”로 손을 쉬게 해요.',
    '오늘은 앱 삭제/홈화면 정리로 유혹을 줄여요.',
    '시간을 정하고, 끝나면 바로 화면을 꺼요.',
    '“한 번 더”가 오면 물 한 잔 마시고 다시 결정해요.',
    '스크롤 대신 메모/일기 3줄로 바꿔요.',
    '연속성이 있으면 하루만 강하게 끊어도 효과가 커요.',
    '지금은 수면이 더 이득일 수 있어요.',
    '침대에서 폰을 하면 손해가 커요. 장소를 바꿔요.',
    '오늘은 폰 대신 “내일 할 일 3개” 적고 자요.',
    '정말 필요하면 “검색만 하고 종료”로 제한해요.',
    '야식/폰 같이 엮이면 루틴이 무너져요. 하나만 끊어봐요.',
    '콘텐츠가 문제면 추천을 끄고 구독만 보세요.',
    '잠들기 루틴(세수/양치/정리)로 폰을 밀어내요.',
    '목이 아프면 화면 대신 오디오로 바꿔요.',
    '오늘은 “폰 0” 대신 “폰 10분”만으로 타협해요.',
    '잠들기 전 폰은 다음 날 피로로 돌아와요. 지금 스탑해요.',
    '만족이 필요하면 폰 대신 산책/샤워로 전환해요.',
    '지금은 스크롤보다 회복이 우선이에요.',
    '내일의 나에게 선물: 오늘은 폰을 내려놓기.',
  ],

  ActionType.game: [
    '오늘은 “한 판만” 하고 종료 룰을 걸어요.',
    '시작 전에 종료 시각을 먼저 정해요.',
    '랭크/경쟁 대신 가벼운 모드로 바꿔요.',
    '게임 전에 스트레칭/물 한 잔으로 완충을 넣어요.',
    '연속이면 하루만 쉬어도 집중력이 돌아와요.',
    '오늘은 게임 대신 산책/운동 10분으로 대체해요.',
    '지금은 “작게 즐기고 마감”이 이득이에요.',
    '친구와 약속이면 시간 상한선을 공유해요.',
    '게임 후에 해야 할 일 1개를 세트로 묶어요.',
    '피곤하면 게임은 내일이 더 재밌어요(오늘은 쉬자).',
    '로딩/대기 시간에 폰을 잡지 말고 몸을 쉬게 해요.',
    '과몰입이 걱정이면 알람 2개(10분 전/종료)를 걸어요.',
    '핵심은 재미가 아니라 회복일 수 있어요. 지금은 쉬어도 돼요.',
    '오늘은 “연속 2판 금지” 같은 룰로 통제해요.',
    '자극이 센 게임이면 더 가벼운 걸로 바꿔요.',
    '연패/화가 나면 바로 종료가 정답이에요.',
    '승부욕이 커지면 손해가 커요. 짧게만.',
    '게임 전에 해야 할 일 1개를 끝내고 시작해요.',
    '오늘은 게임 대신 정리/청소로 도파민을 바꿔봐요.',
    '시간이 늦으면 게임 대신 수면을 지키는 게 이득이에요.',
    '게임이 스트레스면 해결책은 게임이 아닐 수도 있어요.',
    '오늘은 “기록만” 하고 실행은 내일로 미뤄도 돼요.',
    '친구와 하면 더 길어져요. 상한선 공유가 핵심이에요.',
    '오늘은 20분만 하고 종료(타이머)로 가요.',
    '끝난 뒤 후회가 남으면 그건 신호예요. 내일로 미루자.',
    '게임 대신 유튜브/폰으로 넘어가면 더 손해예요. 조심해요.',
    '오늘은 게임 대신 샤워/산책으로 텐션을 바꿔요.',
    '연속성만 끊어도 루틴이 살아나요.',
    '딱 한 번 즐기고 끝내면 충분해요.',
    '내일의 나에게 남길 선택: 오늘은 짧게!',
  ],

  ActionType.caffeine: [
    '오늘은 양을 절반으로 줄여도 충분할 수 있어요.',
    '오후/저녁이면 디카페인으로 바꿔요.',
    '카페인 대신 물/스트레칭으로 먼저 깨워봐요.',
    '목적이 집중이면 “짧은 작업 1개”만 하고 종료해요.',
    '지금은 피로 누적이면 카페인보다 수면이 더 이득이에요.',
    '한 잔 마시기 전 10분 산책으로 대체 효과를 만들어봐요.',
    '카페인을 마신다면 “추가 1잔 금지” 룰을 걸어요.',
    '위가 불편하면 차/따뜻한 물로 바꿔요.',
    '카페인 대신 낮잠 15분이 더 효율적일 수 있어요.',
    '늦은 시간대면 오늘은 패스하는 게 좋아요.',
    '불안/심장이 뛰면 카페인을 줄이는 신호예요.',
    '단맛 카페인이면 “무가당”으로 바꿔요.',
    '지금 필요한 건 각성이 아니라 회복일 수 있어요.',
    '카페인 전에 식사/간식으로 에너지를 보충해요.',
    '오늘은 한 잔만, 두 번째는 디카페인으로.',
    '카페인 섭취 시간을 오전으로 당겨봐요.',
    '카페인 대신 호흡/스트레칭으로 리셋해요.',
    '집중이 필요하면 폰 차단 10분이 더 효과적일 수 있어요.',
    '불가피하면 작은 사이즈로 타협해요.',
    '카페인 이후 물을 같이 마셔서 부담을 줄여요.',
    '오늘은 “카페인 없는 각성 루틴”을 하나 만들자.',
    '피곤의 원인이 수면이면 카페인이 해결이 아니에요.',
    '한 잔 마시고 추가 생각이 들면 “물 한 잔 후 재평가”.',
    '카페인은 “타이밍”이 전부예요. 늦으면 손해가 커요.',
    '카페인 대신 밝은 빛/샤워로 깨워봐요.',
    '지금은 줄이는 쪽이 내일의 나를 살려요.',
    '카페인 대신 따뜻한 차로 리추얼만 유지해요.',
    '오늘은 과감히 패스하고 회복을 선택해도 돼요.',
    '카페인은 도구예요. 목적 1개만 해결하고 끝내요.',
    '내일 컨디션을 위해 오늘은 적게/빠르게/일찍!',
  ],

  ActionType.food: [
    '물/단백질을 먼저 먹고 10분 뒤 다시 결정해요.',
    '정해둔 양만 먹고 추가는 금지해요.',
    '지금 말고 내일로 미루면 후회가 줄 수 있어요.',
    '배고픔이면 “간단한 한 끼”로 바꿔요.',
    '감정이면 음식 대신 산책/샤워/대화로 전환해요.',
    '늦은 시간엔 수면이 더 손해를 줄여줘요. 오늘은 쉬자.',
    '야식이면 “가벼운 옵션”으로만 허용해요.',
    '과자 대신 과일/요거트 같은 대체로 바꿔요.',
    '배달 대신 집에 있는 걸로 해결해요.',
    '먹기 전 10분만 움직이고 다시 결정해요.',
    '폭식 충동이면 “작은 접시”로 양을 제한해요.',
    '빨리 먹지 말고 속도를 줄여요(10분에 50%).',
    '오늘은 “한 번만” 먹고 마감 룰로 가요.',
    '자기 전이면 내일 아침으로 미루는 게 이득이에요.',
    '먹는 대신 따뜻한 차로 리추얼만 유지해요.',
    '정말 먹고 싶으면 작은 버전으로 타협해요.',
    '후회가 예상되면 지금은 멈추는 게 맞아요.',
    '대안: 양치하고 다시 생각하면 욕구가 줄 수 있어요.',
    '단맛이면 “단맛 대체”를 먼저 시도해요.',
    '배고픔/스트레스 구분을 먼저 해요.',
    '오늘은 식사 기록만 하고 실행은 30분 뒤로.',
    '연속이면 하루만 끊어도 리셋이 커요.',
    '폭식은 “환경”이 원인일 때가 많아요. 환경을 바꿔봐요.',
    '그냥 허전하면 음식 대신 음악/정리로 채워봐요.',
    '오늘은 배달앱을 닫고 5분 뒤 다시 판단해요.',
    '먹을 거면 “끝나는 기준”을 먼저 정해요.',
    '지금은 회복이 필요해요. 몸을 먼저 챙겨요.',
    '내일의 나에게 선물: 오늘은 가볍게!',
    '먹기 전 물 한 잔 + 심호흡 5회.',
    '오늘은 “조절”이 승리예요. 완전 금지보다 조절!',
  ],

  ActionType.workout: [
    '오늘은 강도를 낮추고 “짧게라도” 하는 게 좋아요.',
    '피곤하면 스트레칭/산책으로 대체해도 충분해요.',
    '오늘은 10분만 하고 계속할지 결정해요.',
    '연속이면 회복이 우선일 수 있어요. 하루 쉬어도 돼요.',
    '운동을 한다면 마무리 스트레칭까지 세트로 해요.',
    '무거운 것 대신 가벼운 루틴으로 전환해요.',
    '오늘은 “꾸준함”이 목표면 작은 성공으로 끝내요.',
    '운동 전 물/간식으로 컨디션을 보강해요.',
    '지금은 기록만 하고 내일로 미뤄도 돼요.',
    '오늘은 “딱 시작만” 해도 반은 성공이에요.',
    '컨디션이 안 좋으면 회복운동이 더 이득이에요.',
    '오버하면 내일이 무너져요. 강도 조절이 핵심이에요.',
    '시간이 없으면 7분 루틴으로 타협해요.',
    '운동 후 샤워/정리까지 하면 만족이 커져요.',
    '목표는 체력이지 고통이 아니에요. 적당히!',
    '연속 3일이면 오늘은 쉬어도 괜찮아요.',
    '운동을 미루고 싶으면 “운동복만 입기”부터 해요.',
    '지금은 산책 15분이 최고의 대안일 수 있어요.',
    '운동을 한다면 종료 시각을 먼저 정해요.',
    '오늘은 근력 대신 유산소로 바꿔요.',
    '오늘은 유산소 대신 근력 1세트만.',
    '회복이 필요하면 폼롤러/스트레칭으로.',
    '운동은 길이보다 반복이 중요해요. 짧게라도!',
    '지금은 컨디션을 지키는 게 장기적으로 이득이에요.',
    '운동 대신 잠을 선택해도 괜찮아요(회복도 루틴).',
    '오늘은 무리하지 말고 “땀만” 내고 끝내요.',
    '다음날 근육통이 걱정되면 강도를 낮춰요.',
    '운동을 하면 기분이 좋아질까? 그럼 작은 버전으로 시작!',
    '오늘은 “하기”보다 “지속”을 선택해요.',
    '내일의 나에게 남길 선택: 오늘은 가볍게!',
  ],

  ActionType.selfcare: [
    '오늘은 루틴을 유지하는 것만으로도 충분히 좋아요.',
    '작게라도 하면 흐름이 살아나요.',
    '너무 완벽하게 하려면 오히려 힘들어요. 작은 버전으로!',
    '1개만 고르고 끝내도 돼요.',
    '오늘은 “피부/정리/샤워” 중 하나만 해도 성공이에요.',
    '자기관리는 길이보다 지속이 이득이에요.',
    '시간이 없으면 5분 버전으로 타협해요.',
    '내일의 나가 고마워할 선택을 하나만 해요.',
    '지금은 회복이 필요해요. 부드럽게 가요.',
    '자기관리 후에는 바로 쉬는 루틴까지 세트로.',
    '오늘은 정리 1개만 하고 마감!',
    '너무 몰아치지 말고 “가볍게”가 답이에요.',
    '오늘은 몸이 원하는 걸 하나만 들어줘요.',
    '자기관리→기록까지 하면 루틴이 붙어요.',
    '피곤하면 쉬는 것도 자기관리예요.',
    '너무 늦었으면 짧게만 하고 수면을 지켜요.',
    '완벽 대신 “꾸준함”으로 가요.',
    '오늘은 보상보다 회복이 포인트예요.',
    '지금은 작은 승리가 큰 승리예요.',
    '딱 10분만 투자하고 끝내요.',
    '마무리 규칙을 정하면 더 편해져요.',
    '자기관리의 목적(회복/정리/리셋)만 분명히 해요.',
    '오늘은 스트레스 낮추는 버전으로.',
    '내일 일정이 있으면 오늘은 가볍게!',
    '지금 컨디션이 올라오면 다른 선택도 좋아져요.',
    '자기관리 후 폰/야식으로 무너지지 않게 조심해요.',
    '오늘은 루틴을 “이어붙이기”가 목표예요.',
    '너무 길게 하지 말고 “시작→끝”을 경험해요.',
    '작게 끝내면 내일 또 하기 쉬워져요.',
    '오늘은 나를 챙기는 날. 작은 걸로도 충분해요.',
  ],

  ActionType.rest: [
    '휴식이 필요하면 “짧고 선명하게” 쉬는 게 좋아요.',
    '타이머 20분만 쉬고 다시 시작해요.',
    '휴식 후 해야 할 것 1개만 정해두면 복귀가 쉬워요.',
    '휴식이 길어지면 불안이 올라와요. 선을 정해요.',
    '지금은 회복이 먼저예요. 쉬어도 돼요.',
    '휴식 대신 산책/샤워로 리셋도 가능해요.',
    '오늘은 “휴식의 질”을 올려봐요(폰 없이).',
    '눈을 감고 5분만 숨을 고르는 것도 휴식이에요.',
    '휴식 후 물 한 잔/정리 1개로 복귀 신호를 줘요.',
    '피곤하면 자도 돼요. 수면은 최고의 휴식이에요.',
    '휴식이 필요하면 죄책감 없이 쉬어도 돼요.',
    '오늘은 과부하 신호일 수 있어요. 회복이 이득이에요.',
    '휴식할 거면 “끝나는 기준”을 먼저 정해요.',
    '짧게 쉬면 오히려 생산성이 올라가요.',
    '휴식 중엔 자극을 줄이는 게 핵심이에요.',
    '오늘은 휴식 후 “딱 한 가지”만 해도 성공이에요.',
    '휴식이 길어지면 내일이 힘들어져요. 선을 걸어요.',
    '휴식이 필요하면 루틴 보호 모드로 가요.',
    '지금은 멈추는 용기도 실력이에요.',
    '쉬고 나서 다시 판단하면 답이 더 잘 보여요.',
    '휴식 대신 스트레칭 3분도 좋아요.',
    '휴식 후 폰으로 빠지면 회복이 안돼요. 폰은 잠깐 내려놔요.',
    '오늘은 쉬는 게 이득일 수 있어요.',
    '잠깐 멈춰도 괜찮아요. 흐름은 다시 만들 수 있어요.',
    '휴식이 필요하면 작은 휴식부터.',
    '오늘은 쉬되, 내일을 살리는 방식으로 쉬어요.',
    '휴식 후 할 일 1개만 정하고 쉬어요.',
    '휴식은 도망이 아니라 회복이에요.',
    '쉬고 싶으면 쉬어도 돼요. 대신 선을 정해요.',
    '휴식 후 “복귀 루틴”을 하나 만들자.',
  ],
};

// ---------- selection rules ----------
List<String Function(PatternLite p)> _selectFactList(PatternLite p, ReasonTone tone) {
  if (tone == ReasonTone.strongNo || tone == ReasonTone.no || tone == ReasonTone.maybe) {
    if (p.streak >= 3) return _factsStreak;
    if (p.hoursSinceLast <= 18) return _factsGap;
    if (p.cnt3 >= 2 || p.cnt5 >= 3) return _factsFreq;
    return _factsFreq;
  }
  if (p.cnt3 <= 1 && p.hoursSinceLast >= 24) return _factsStable;
  return _factsFreq;
}

List<String> _selectInterpretList(PatternLite p, ReasonTone tone) {
  if (tone == ReasonTone.strongNo) {
    if (p.hoursSinceLast <= 12 || p.streak >= 3) return _interpretRecoveryNeed;
    return _interpretHabitRisk;
  }
  if (tone == ReasonTone.no) {
    if (p.cnt3 >= 2 || p.cnt5 >= 3) return _interpretHabitRisk;
    return _interpretContextSignal;
  }
  if (tone == ReasonTone.maybe) {
    if (p.hoursSinceLast <= 18) return _interpretRecoveryNeed;
    return _interpretContextSignal;
  }
  if (p.cnt3 <= 1 && p.hoursSinceLast >= 24) return _interpretStable;
  return _interpretContextSignal;
}

List<String> _selectAltList(ActionType type) => _altsByType[type] ?? _altsByType[ActionType.general]!;

/// 최종 문구 1세트 생성
ReasonPack buildReasonPack({
  required String result,         // STRONG_OK/OK/MAYBE/NO/STRONG_NO
  required PatternLite pattern,
  required int seed,              // 행동+score 등으로 시드 주면 반복 줄어듦
  required ActionType actionType, // 행동 타입별 맞춤 대안
}) {
  final tone = _toneFromResult(result);
  final r = Random(seed);

  final factFn = _pickOne(_selectFactList(pattern, tone), r);
  final interpret = _pickOne(_selectInterpretList(pattern, tone), r);
  final alt = _pickOne(_selectAltList(actionType), r);

  return ReasonPack(
    fact: factFn(pattern),
    interpret: interpret,
    alternative: alt,
  );
}
